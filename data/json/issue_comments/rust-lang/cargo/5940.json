[{"url": "https://api.github.com/repos/rust-lang/cargo/issues/comments/415988683", "html_url": "https://github.com/rust-lang/cargo/issues/5940#issuecomment-415988683", "issue_url": "https://api.github.com/repos/rust-lang/cargo/issues/5940", "id": 415988683, "node_id": "MDEyOklzc3VlQ29tbWVudDQxNTk4ODY4Mw==", "user": {"login": "ehuss", "id": 43198, "node_id": "MDQ6VXNlcjQzMTk4", "avatar_url": "https://avatars0.githubusercontent.com/u/43198?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ehuss", "html_url": "https://github.com/ehuss", "followers_url": "https://api.github.com/users/ehuss/followers", "following_url": "https://api.github.com/users/ehuss/following{/other_user}", "gists_url": "https://api.github.com/users/ehuss/gists{/gist_id}", "starred_url": "https://api.github.com/users/ehuss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ehuss/subscriptions", "organizations_url": "https://api.github.com/users/ehuss/orgs", "repos_url": "https://api.github.com/users/ehuss/repos", "events_url": "https://api.github.com/users/ehuss/events{/privacy}", "received_events_url": "https://api.github.com/users/ehuss/received_events", "type": "User", "site_admin": false}, "created_at": "2018-08-25T18:41:18Z", "updated_at": "2018-08-25T18:41:18Z", "author_association": "CONTRIBUTOR", "body": "@alexcrichton Do you have any opinion on how to proceed?\r\n\r\nEssentially any test that does:\r\n1. Create or modify a file.\r\n2. Build something.\r\n3. Build again.\r\n\r\nWhere step 2 finishes within 1 second, and step 3 expects the results from 2 to be fresh can fail.\r\n\r\nAdding sleeps to all these tests doesn't sound great, and will be a problem that will likely plague future tests.  The only real option I can think of is to hash the sources, but I think you've said in the past that you don't want to do that?  \r\n\r\nWe could back out the mtime change, but it does seem disappointing that touching a file immediately after a build would not count as dirty."}, {"url": "https://api.github.com/repos/rust-lang/cargo/issues/comments/416073446", "html_url": "https://github.com/rust-lang/cargo/issues/5940#issuecomment-416073446", "issue_url": "https://api.github.com/repos/rust-lang/cargo/issues/5940", "id": 416073446, "node_id": "MDEyOklzc3VlQ29tbWVudDQxNjA3MzQ0Ng==", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars1.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "created_at": "2018-08-26T21:25:36Z", "updated_at": "2018-08-26T21:25:36Z", "author_association": "MEMBER", "body": "Hm so one thing I've always wanted to perfect in the past is just manually changing the mtimes on files. Could that be done to simulate a sleep perhaps?"}, {"url": "https://api.github.com/repos/rust-lang/cargo/issues/comments/416082616", "html_url": "https://github.com/rust-lang/cargo/issues/5940#issuecomment-416082616", "issue_url": "https://api.github.com/repos/rust-lang/cargo/issues/5940", "id": 416082616, "node_id": "MDEyOklzc3VlQ29tbWVudDQxNjA4MjYxNg==", "user": {"login": "ehuss", "id": 43198, "node_id": "MDQ6VXNlcjQzMTk4", "avatar_url": "https://avatars0.githubusercontent.com/u/43198?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ehuss", "html_url": "https://github.com/ehuss", "followers_url": "https://api.github.com/users/ehuss/followers", "following_url": "https://api.github.com/users/ehuss/following{/other_user}", "gists_url": "https://api.github.com/users/ehuss/gists{/gist_id}", "starred_url": "https://api.github.com/users/ehuss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ehuss/subscriptions", "organizations_url": "https://api.github.com/users/ehuss/orgs", "repos_url": "https://api.github.com/users/ehuss/repos", "events_url": "https://api.github.com/users/ehuss/events{/privacy}", "received_events_url": "https://api.github.com/users/ehuss/received_events", "type": "User", "site_admin": false}, "created_at": "2018-08-26T23:59:35Z", "updated_at": "2018-08-26T23:59:35Z", "author_association": "CONTRIBUTOR", "body": "That's an interesting idea for some of the tests, but I would be reluctant to try to cover dozens of tests with that kind of logic.\r\n\r\nOne idea I had would be to add hashing only to files that were modified around the time the build starts (say within 2 seconds or so).  That would likely avoid performance issues with hashing larger projects, and make cargo resilient against imprecise mtimes."}, {"url": "https://api.github.com/repos/rust-lang/cargo/issues/comments/416296071", "html_url": "https://github.com/rust-lang/cargo/issues/5940#issuecomment-416296071", "issue_url": "https://api.github.com/repos/rust-lang/cargo/issues/5940", "id": 416296071, "node_id": "MDEyOklzc3VlQ29tbWVudDQxNjI5NjA3MQ==", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars1.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "created_at": "2018-08-27T17:07:11Z", "updated_at": "2018-08-27T17:07:11Z", "author_association": "MEMBER", "body": "It's true yeah that'd work! I'm hesitant though to implement such a large change just to fix a few tests. I can try to test out the changes for moving mtimes into the future when I get a chance, but something like hashing should likely be done as its own standalone feature (with its own discussion and whatnot)"}, {"url": "https://api.github.com/repos/rust-lang/cargo/issues/comments/417426833", "html_url": "https://github.com/rust-lang/cargo/issues/5940#issuecomment-417426833", "issue_url": "https://api.github.com/repos/rust-lang/cargo/issues/5940", "id": 417426833, "node_id": "MDEyOklzc3VlQ29tbWVudDQxNzQyNjgzMw==", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars1.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "created_at": "2018-08-30T18:46:59Z", "updated_at": "2018-08-30T18:46:59Z", "author_association": "MEMBER", "body": "So here's my rough idea of how to solve this -- https://gist.github.com/alexcrichton/2cc9269dbd3061d36aa4e3b66ab60a56\r\n\r\nThe idea there is that let's try to make cargo's test suite actually consistent across all platforms, and let's stop dealing with filesystem weirdness and spurious failures on CI. To that end the test suite unconditionally moves *everything* (except the target directory) to a known time just before we ever run Cargo. This means that unless further action is taken, the test suite will assume that all files were created at the start of the build and creating files randomly in tests won't actually work.\r\n\r\nWe'd then add a method saying \"dear project, please update this file\" at which point it would store a new mtime for the file (something like the original mtime plus two seconds). When unconditionally setting the mtime of all files, registered and whitelisted files would be allowed future timestamps.\r\n\r\nThis, I hope, can result in:\r\n\r\n* No more sleep is needed\r\n* All the haphazard `move_into_the_past` can be removed. (I don't think they ever worked anyway)\r\n* Nanosecond resolution shouldn't matter, we're always doing things on the granularity of seconds\r\n* We can't make a mistake by creating a file in the middle of a test\r\n\r\nThat change definitely breaks tons of tests we'd need to fixup. We'd also need to add probably helper methods for \"please update this file to these contents\". My guess is that Cargo may also need a slightly tweak here and there as well.\r\n\r\nDoes that sound reasonable? Would you be willing to help tackle this?"}, {"url": "https://api.github.com/repos/rust-lang/cargo/issues/comments/417492889", "html_url": "https://github.com/rust-lang/cargo/issues/5940#issuecomment-417492889", "issue_url": "https://api.github.com/repos/rust-lang/cargo/issues/5940", "id": 417492889, "node_id": "MDEyOklzc3VlQ29tbWVudDQxNzQ5Mjg4OQ==", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars1.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "created_at": "2018-08-30T22:52:16Z", "updated_at": "2018-08-30T22:52:16Z", "author_association": "MEMBER", "body": "Actually I'm almost done finishing off a patch that does this, I'll post for review soon"}, {"url": "https://api.github.com/repos/rust-lang/cargo/issues/comments/417504196", "html_url": "https://github.com/rust-lang/cargo/issues/5940#issuecomment-417504196", "issue_url": "https://api.github.com/repos/rust-lang/cargo/issues/5940", "id": 417504196, "node_id": "MDEyOklzc3VlQ29tbWVudDQxNzUwNDE5Ng==", "user": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars1.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "created_at": "2018-08-30T23:50:50Z", "updated_at": "2018-08-30T23:50:50Z", "author_association": "MEMBER", "body": "Ok, I've posted https://github.com/rust-lang/cargo/pull/5953"}]